{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'navbar.html' %}

<!-- Spacer -->
<div class="h-16 md:h-19"></div>

<!-- ===== PAGE WRAPPER ===== -->
<div class="min-h-screen py-10 px-4 bg-[var(--color-main-50)]">
  <div class="max-w-5xl mx-auto bg-white rounded-[2rem] shadow-[0_8px_32px_rgba(0,0,0,0.05)] p-8">

    <!-- Organizer Info -->
    <div class="flex items-center mb-6">
      <a href="{% url 'profile:profile_view_user' event.organizer.user.username %}" class="group">
          {% if event.organizer.profile_picture %}
            <img src="{{ event.organizer.profile_picture.url }}" alt="Organizer"
                 class="w-10 h-10 rounded-full border border-[var(--color-main-200)] mr-3 object-cover group-hover:opacity-80 transition-opacity">
          {% else %}
            <img src="{% static 'images/profile-default.png' %}" alt="Organizer"
                 class="w-10 h-10 rounded-full border border-[var(--color-main-200)] mr-3 object-cover group-hover:opacity-80 transition-opacity">
          {% endif %}
      </a>
      <p class="text-[var(--color-text-400)] text-sm">
        Organized by:
        <span class="font-semibold text-[var(--color-main-600)]">
          {{ event.organizer.user.username }}
        </span>
      </p>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

      <!-- LEFT: Thumbnail -->
      <div>
        {% if event.thumbnail %}
          <img src="{{ event.thumbnail }}" alt="{{ event.name }}"
               class="rounded-2xl w-full object-cover shadow-md">
        {% else %}
          <img src="{% static 'images/default-thumbnail.png' %}" alt="{{ event.name }}"
               class="rounded-2xl w-full object-cover shadow-md opacity-90">
        {% endif %}
      </div>

      <!-- RIGHT: Info -->
      <div class="flex flex-col justify-between">

        <div>
          <!-- Categories + Edit -->
          <div class="flex items-center justify-between mb-3">
            <div class="flex gap-2 flex-wrap">
              <span class="bg-[var(--color-main-100)] text-[var(--color-main-600)] text-xs px-3 py-1 rounded-full">
                {{ event.get_sports_category_display }}
              </span>
              <span class="bg-[var(--color-main-100)] text-[var(--color-main-600)] text-xs px-3 py-1 rounded-full">
                {{ event.get_activity_category_display }}
              </span>
            </div>

            {% if request.user.is_authenticated and event.organizer.user == request.user %}
              <a href="{% url 'Event:edit_event' event.id %}"
                 class="btn btn-gradient text-xs font-semibold h-8 px-4">
                Edit Event
              </a>
            {% endif %}
          </div>

          <!-- Name + Fee -->
          <div class="flex justify-between items-start mb-3">
            <h1 class="text-2xl font-bold text-[var(--color-main-800)] leading-snug max-w-[75%]">
              {{ event.name }}
            </h1>
            <p class="font-semibold text-[var(--color-main-600)] whitespace-nowrap">
              {% if event.fee %}
                IDR {{ formatted_fee }}
              {% else %}
                Free
              {% endif %}
            </p>
          </div>

          <!-- Time -->
          <p class="text-[var(--color-text-400)] text-sm mb-3">
            {% if not event.end_time %}
              {{ event.start_time|date:"d M Y • H:i" }}
            {% elif event.start_time|date:"Y-m-d H:i" == event.end_time|date:"Y-m-d H:i" %}
              {{ event.start_time|date:"d M Y • H:i" }}
            {% elif event.start_time|date:"Y-m-d" == event.end_time|date:"Y-m-d" %}
              {{ event.start_time|date:"d M Y • H:i" }} - {{ event.end_time|date:"H:i" }}
            {% else %}
              {{ event.start_time|date:"d M Y • H:i" }} - {{ event.end_time|date:"d M Y, H:i" }}
            {% endif %}
          </p>

          <!-- Location -->
          <p class="font-semibold text-[var(--color-text-600)]">Location</p>
          <p class="text-[var(--color-text-400)] text-sm mb-4">{{ event.location }}</p>

          <!-- Description -->
          <div class="max-h-48 overflow-y-auto whitespace-pre-line text-[var(--color-text-600)] text-sm leading-relaxed mt-4">
            {{ event.description }}
          </div>
        </div>

        <!-- Attendees Section -->
        <div class="mt-5">
          <h2 class="text-orange-600 font-semibold text-lg mb-2">Attendees</h2>

          {% if event.attendee.count > 0 %}
            <div class="flex items-center">
              <button type="button" onclick="openAttendeesModal()"
                      class="flex item-center group hover:bg-gray-50 p-2 -ml-2 rounded-xl transition-all cursor-pointer">
                    
                <!-- Foto attendee -->
                <div class="flex -space-x-3">
                {% for participant in event.attendee.all|slice:":5" %}
                    <img src="{% if participant.profile_picture %}{{ participant.profile_picture.url }}{% else %}{% static 'images/profile-default.png' %}{% endif %}" 
                        alt="{{ participant.user.username }}" 
                        class="w-10 h-10 rounded-full border-2 border-white shadow-md object-cover">
                {% endfor %}
                </div>
              </button>

              <!-- Counter -->
              <span class="text-gray-600 text-sm font-medium ml-2" data-attendee-counter>
                {{ event.attendee.count }}/{{ event.capacity }}
              </span>
            </div>
          {% else %}
            <!-- Belum ada yang ikut -->
            <div class="flex items-center gap-2">
              <div class="w-12 h-12 rounded-full border-2 border-dashed border-gray-400 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
              </div>
              <p class="text-gray-500 text-sm">Belum ada yang join</p>
            </div>
          {% endif %}
        </div>

        <!-- Buttons -->
        {% if is_participant %}
          <div class="flex gap-4 items-center justify-end mt-6">
            <!-- Join Button -->
            <button
              type="button"
              id="bookEventBtn"
              data-event-id="{{ event.id }}"
              class="btn btn-gradient font-semibold text-sm px-8 h-11 shadow-md hover:shadow-lg transition-all duration-300"
            >
              Book Event
            </button>
            <!-- Bookmark Button -->
            <button type="button"
                    id="bookmarkBtn"
                    data-bookmarked="{{ is_bookmarked|yesno:'true,false' }}"
                    aria-label="Bookmark event"
                    class="bookmark-btn group {% if is_bookmarked %}active{% endif %}">
              <div class="bookmark-bg"></div>
              <img src="{% static 'icons/bookmark-default.png' %}"
                   alt="Bookmark icon"
                   class="bookmark-icon" />
              <span class="tooltip">Bookmark event</span>
            </button>
          </div>
        {% endif %}
      </div>
    </div>

    <hr class="my-10 border-[var(--color-main-100)]">

    <!-- Forum & Review -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-[var(--color-main-50)] rounded-2xl p-6 border border-[var(--color-main-100)]">
        <h2 class="text-[var(--color-main-600)] font-semibold mb-3 text-lg">Forum</h2>
        <a href="{% url 'Forum:forum_page' event.id %}"
          class="btn btn-gradient font-semibold w-full mt-2">
          Go to Forum
        </a>
      </div>

      <div class="bg-[var(--color-main-50)] rounded-2xl p-6 border border-[var(--color-main-100)]">
        <h2 class="text-[var(--color-main-600)] font-semibold mb-3 text-lg">Review</h2>
        <a href="{% url 'Review:review_page' event.id %}"
          class="btn btn-gradient font-semibold w-full mt-2">
          Go to Review
        </a>
      </div>
    </div>

  <!-- ==== JOIN MODAL ==== -->
  <div id="joinModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-lg p-6 w-80 text-center">
      <h3 class="text-lg font-semibold text-[var(--color-main-600)] mb-4">Join this event?</h3>
      <div id="joinEventInfo" class="text-[var(--color-text-500)] text-sm space-y-1 mb-4">
        <!-- info event dimasukin lewat JS -->
      </div>
      <div class="flex justify-center gap-4">
        <button id="confirmJoinBtn" class="btn btn-gradient">Yes</button>
        <button id="cancelJoinBtn" class="btn bg-gray-200 text-gray-800 hover:bg-gray-300">No</button>
      </div>
    </div>
  </div>

  <div id="attendeesModal" tabindex="-1" aria-hidden="true" 
     class="hidden fixed inset-0 z-[60] flex items-center justify-center w-full h-full bg-black/50 backdrop-blur-sm transition-opacity opacity-0 duration-300">
    
    <div class="relative p-4 w-full max-w-sm h-auto"> <div class="relative bg-white rounded-2xl shadow-2xl transform scale-95 transition-transform duration-300" id="attendeesModalContent">
            
      <div class="relative flex items-center justify-center p-4 border-b border-gray-100">
          
          <h3 class="text-lg font-bold text-gray-800">
              Attendees <span class="text-gray-400 text-sm font-normal ml-1">({{ event.attendee.count }})</span>
          </h3>

          <button type="button" onclick="closeAttendeesModal()" 
                  class="absolute right-4 text-gray-400 bg-transparent hover:bg-gray-100 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center">
              <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
              </svg>
          </button>
      </div>

            <div class="p-2 overflow-y-auto max-h-64 custom-scrollbar"> {% for participant in event.attendee.all %}
                <a href="{% url 'profile:profile_view_user' participant.user.username %}" class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-xl transition-colors group">
                    <img src="{% if participant.profile_picture %}{{ participant.profile_picture.url }}{% else %}{% static 'images/profile-default.png' %}{% endif %}" 
                         alt="{{ participant.full_name }}" 
                         class="w-10 h-10 rounded-full object-cover border border-gray-100">
                    
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-900 truncate group-hover:text-orange-600 transition-colors">
                            {{ participant.full_name }}
                        </p>
                        <p class="text-xs text-gray-500 truncate">
                            @{{ participant.user.username }}
                        </p>
                    </div>

                    <svg class="w-4 h-4 text-gray-300 group-hover:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
                {% endfor %}

                {% if event.attendee.count == 0 %}
                    <div class="text-center py-8 text-gray-400 text-sm">
                        Belum ada peserta.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

</div>

<!-- ===== JS ===== -->
<script>
  // ==== BOOKMARK TOGGLE ====
  (function () {
    const btn = document.getElementById("bookmarkBtn");
    if (!btn) return;

    const eventId = "{{ event.id }}";
    const csrftoken = document.cookie
      .split("; ")
      .find((row) => row.startsWith("csrftoken="))
      ?.split("=")[1];

    let isBookmarked = btn.dataset.bookmarked === "true";
    const icon = btn.querySelector(".bookmark-icon");

    function renderBookmark() {
      btn.classList.toggle("active", isBookmarked);
      icon.src = isBookmarked
        ? "/static/icons/bookmark-toggle.png"
        : "/static/icons/bookmark-default.png";
    }

    renderBookmark();

    btn.addEventListener("click", async () => {
      try {
        const res = await fetch(`/bookmark/${eventId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrftoken },
        });
        if (res.redirected) {
          window.location.href = res.url;
          return;
        }
        const data = await res.json();
        isBookmarked = data.status === "added";
        renderBookmark();
      } catch (err) {
        console.error("Bookmark toggle error:", err);
      }
    });
  })();

// ==== JOIN EVENT ====
(function () {
  const bookBtn = document.getElementById("bookEventBtn");
  const modal = document.getElementById("joinModal");
  const infoBox = document.getElementById("joinEventInfo");
  const confirmBtn = document.getElementById("confirmJoinBtn");
  const cancelBtn = document.getElementById("cancelJoinBtn");
  if (!bookBtn || !modal) return;

  const eventId = bookBtn.dataset.eventId;
  const csrftoken = document.cookie
    .split("; ")
    .find((row) => row.startsWith("csrftoken="))
    ?.split("=")[1];

  // ambil data event dari template
  const eventName = "{{ event.name|escapejs }}";
  const eventLoc = "{{ event.location|escapejs }}";
  const eventTime = `{% if not event.end_time %}{{ event.start_time|date:"l, d M Y • H:i" }}{% else %}{{ event.start_time|date:"l, d M Y • H:i" }} - {{ event.end_time|date:"d M Y, H:i" }}{% endif %}`;
  const eventFee = `{% if event.fee %}IDR {{ formatted_fee }}{% else %}Free{% endif %}`;

  // klik tombol → buka modal
  bookBtn.addEventListener("click", () => {
    infoBox.innerHTML = `
      <p><span class="font-medium text-gray-700">Event:</span> ${eventName}</p>
      <p><span class="font-medium text-gray-700">Location:</span> ${eventLoc}</p>
      <p><span class="font-medium text-gray-700">Time:</span> ${eventTime}</p>
      <p><span class="font-medium text-gray-700">Fee:</span> ${eventFee}</p>
    `;
    modal.classList.remove("hidden");
  });

  // tombol batal → tutup modal
  cancelBtn.addEventListener("click", () => modal.classList.add("hidden"));

  // tombol konfirmasi → kirim join request
  confirmBtn.addEventListener("click", async () => {
    try {
      const res = await fetch(`/event/${eventId}/join/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      const data = await res.json();
      if (data.ok) {
        if (typeof showToast === "function") {
          showToast("Successfully joined event!", "success");
        } else {
          alert("Successfully joined event!");
        }
        if (typeof checkNewNotifications === "function") {
          checkNewNotifications();
        }
        if (typeof updateNotificationBadge === "function") {
          updateNotificationBadge();
        }
      } else {
        if (typeof showToast === "function") {
          showToast(data.error || "Failed to join event.", "error");
        } else {
          alert(data.error || "Failed to join event.");
        }
      }
    } catch (err) {
      console.error("Join error:", err);
      if (typeof showToast === "function") {
        showToast("There was an error. Try again.", "error");
      } else {
        alert("There was an error. Try again.");
      }
    } finally {
      modal.classList.add("hidden");
    }
  });
})();

  // === MODAL ATTENDEES ===
  const attendeesModal = document.getElementById('attendeesModal');
    const attendeesContent = document.getElementById('attendeesModalContent');

    function openAttendeesModal() {
        if(!attendeesModal) return;
        attendeesModal.classList.remove('hidden');
        setTimeout(() => {
            attendeesModal.classList.remove('opacity-0');
            attendeesContent.classList.remove('scale-95');
            attendeesContent.classList.add('scale-100');
        }, 10);
    }

    function closeAttendeesModal() {
        if(!attendeesModal) return;
        attendeesModal.classList.add('opacity-0');
        attendeesContent.classList.remove('scale-100');
        attendeesContent.classList.add('scale-95');
        
        setTimeout(() => {
            attendeesModal.classList.add('hidden');
        }, 300);
    }

    window.addEventListener('click', function(event) {
        if (event.target === attendeesModal) {
            closeAttendeesModal();
        }
    });

</script>

{% endblock content %}
