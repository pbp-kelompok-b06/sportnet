{% extends 'base.html' %}   
{% load static %}

{% block content %}
{% include 'navbar.html' %}  
<div class="h-16 md:h-19"></div>

<div class="min-h-screen bg-gradient-to-b from-[#FFF8F5] to-[#FFE9E0] py-10 px-4">
  <div class="max-w-5xl mx-auto bg-white rounded-[2rem] shadow-lg p-8">
    
    <!-- Organizer -->
    <div class="flex items-center mb-6">
      {% if event.organizer.profile_picture %}
        <img src="{{ event.organizer.profile_picture.url }}" alt="Organizer" class="w-10 h-10 rounded-full mr-3">
      {% endif %}
      <p class="text-gray-600 text-sm">
        Organized by: <span class="font-semibold text-orange-500">{{ event.organizer.user.username }}</span>
      </p>
    </div>

    <!-- Main content grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Left side: image -->
      <div>
        {% if event.thumbnail %}
          <img src="{{ event.thumbnail }}" alt="{{ event.name }}" class="rounded-xl w-full object-cover">
        {% else %}
          <img src="{% static 'images/default_event.jpg' %}" alt="{{ event.name }}" class="rounded-xl w-full object-cover">
        {% endif %}
      </div>

      <!-- Right side: info -->
      <div class="flex flex-col justify-between">
        <div>
          <!-- Categories -->
          <div class="flex gap-2 mb-3">
            <span class="bg-orange-100 text-orange-600 text-xs px-3 py-1 rounded-full">
              {{ event.get_sports_category_display }}
            </span>
            <span class="bg-orange-100 text-orange-600 text-xs px-3 py-1 rounded-full">
              {{ event.get_activity_category_display }}
            </span>
          </div>

          <!-- Event name and fee -->
          <div class="flex justify-between items-center mb-2">
            <h1 class="text-2xl font-bold text-orange-700">{{ event.name }}</h1>
            <p class="font-semibold text-orange-600">
              {% if event.fee %}
                IDR {{ formatted_fee }}
              {% else %}
                Free
              {% endif %}
            </p>
          </div>

        <!-- Time and location -->
        <div class="text-gray-600 text-sm mt-1">
            {% if not event.end_time %}
                {{ event.start_time|date:"d M Y • H:i" }}
            {% elif event.start_time|date:"Y-m-d H:i" == event.end_time|date:"Y-m-d H:i" %}
                {{ event.start_time|date:"d M Y • H:i" }}
            {% elif event.start_time|date:"Y-m-d" == event.end_time|date:"Y-m-d" %}
                {# sama hari, jam beda → "24 Oct 2025, 10:00 - 12:00" #}
                {{ event.start_time|date:"d M Y • H:i" }} - {{ event.end_time|date:"H:i" }}
            {% else %}
                {# beda hari → full rentang tanggal #}
                {{ event.start_time|date:"d M Y • H:i" }} - {{ event.end_time|date:"d M Y, H:i" }}
            {% endif %}
        </div>

          <p class="font-semibold text-gray-700 mt-4">Location</p>
          <p class="text-gray-500 text-sm mb-4">{{ event.location }}</p>

          

          <!-- Description -->
          <div class="max-h-48 overflow-y-auto whitespace-pre-line text-gray-700 mt-6">
            {{ event.description }}
          </div>
        </div>

        <!-- Attendees Section -->
<div class="mt-5">
  <h2 class="text-orange-600 font-semibold text-lg mb-2">Attendees</h2>

  {% if event.attendee.count > 0 %}
    <div class="flex items-center gap-3">
      <!-- Foto attendee -->
      {% for participant in event.attendee.all|slice:":5" %}
        <img src="{{ participant.profile_picture.url|default:'{% static "images/default_profile.jpg" %}' }}" 
             alt="{{ participant.user.username }}" 
             class="w-10 h-10 rounded-full border-2 border-white shadow-md object-cover">
      {% endfor %}

      <!-- Counter -->
      <span class="text-gray-600 text-sm font-medium ml-2" data-attendee-counter>
        {{ event.attendee.count }}/{{ event.capacity }}
      </span>
    </div>
  {% else %}
    <!-- Belum ada yang ikut -->
    <div class="flex items-center gap-2">
      <div class="w-12 h-12 rounded-full border-2 border-dashed border-gray-400 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
      </div>
      <p class="text-gray-500 text-sm">Belum ada yang join</p>
    </div>
  {% endif %}
</div>


       
        <!-- Buttons -->
        <div class="flex gap-4 items-center justify-end mt-6">
    
          <button type="button" id="bookEventBtn" data-event-id="{{ event.id }}" class="btn px-8 h-11 text-base 
                        bg-gradient-to-b from-[var(--color-main-300)] to-[var(--color-main-400)] 
                        text-white font-semibold border-none shadow-lg
                        hover:shadow-xl hover:-translate-y-0.5 
                        transition-all duration-200 ease-in-out">
            Book Event
          </button>

           <!-- Bookmark toggle -->
          <button type="button"
                  id="bookmarkBtn"
                  data-bookmarked="{{ is_bookmarked|yesno:'true,false' }}"
                  aria-label="Bookmark event"
                  aria-pressed="{% if is_bookmarked %}true{% else %}false{% endif %}"
                  class="bookmark-btn w-11 h-11 rounded-full grid place-items-center
               bg-gradient-to-b from-[var(--color-main-300)] to-[var(--color-main-400)] 
               hover:shadow-xl hover:-translate-y-0.5 shadow-lg
               transition-all duration-200 ease-in-out">
            <!-- Background pakai state via class; isi SVG di-toggle via JS -->
            <svg viewBox="0 0 24 24" class="w-6 h-6"
                stroke=white stroke-width="2"
                fill="{% if is_bookmarked %}currentColor{% else %}none{% endif %}">
              <!-- Heroicons bookmark shape -->
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M6 4a2 2 0 0 0-2 2v14l8-4 8 4V6a2 2 0 0 0-2-2H6z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Divider -->
    <hr class="my-8 border-orange-100">

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <!-- Forum -->
  <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6">
    <h2 class="text-orange-600 font-semibold text-lg mb-3">Forum</h2>
    <a href="{% url 'forum:forum_page' event.id %}"
       class="btn px-8 h-11 text-base 
              bg-gradient-to-b from-[var(--color-main-300)] to-[var(--color-main-400)] 
              text-white font-semibold border-none shadow-lg
              hover:shadow-xl hover:-translate-y-0.5 
              transition-all duration-200 ease-in-out inline-flex items-center justify-center">
      Go to Forum
    </a>
  </div>

  <!-- Review -->
  <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6">
    <h2 class="text-orange-600 font-semibold text-lg mb-3">Review</h2>
    <a href="{% url 'review:add_review' event.id %}"
       class="btn px-8 h-11 text-base 
              bg-gradient-to-b from-[var(--color-main-300)] to-[var(--color-main-400)] 
              text-white font-semibold border-none shadow-lg
              hover:shadow-xl hover:-translate-y-0.5 
              transition-all duration-200 ease-in-out inline-flex items-center justify-center">
      Go to Review
    </a>
  </div>
</div>

  </div>
</div>

<!-- Join Confirmation Modal -->
<div id="joinModal"
     class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-80 text-center">
    <h3 class="text-lg font-semibold text-orange-600 mb-4">Join this event?</h3>
    <div id="joinEventInfo" class="text-gray-600 text-sm space-y-1 mb-4">
      <!-- info event dimasukin lewat JS -->
    </div>
    <div class="flex justify-center gap-4">
      <button id="confirmJoinBtn"
              class="bg-gradient-to-b from-[var(--color-main-300)] to-[var(--color-main-400)]
                     text-white px-5 py-2 rounded-lg shadow hover:shadow-lg hover:-translate-y-0.5 
                     transition-all duration-200 ease-in-out">
        Yes
      </button>
      <button id="cancelJoinBtn"
              class="bg-gray-200 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-300 transition">
        No
      </button>
    </div>
  </div>
</div>

<script>
  // ==== BOOKMARK TOGGLE ====
  (function () {
    const btn = document.getElementById('bookmarkBtn');
    if (!btn) return;
    const svg = btn.querySelector('svg');
    let isBookmarked = btn.dataset.bookmarked === "true";
    function renderBookmark() {
      btn.classList.toggle('is-active', isBookmarked);
      btn.setAttribute('aria-pressed', isBookmarked ? 'true' : 'false');
      svg.setAttribute('fill', isBookmarked ? 'white' : 'none');
    }
    renderBookmark();
    btn.addEventListener('click', async () => {
      isBookmarked = !isBookmarked;
      renderBookmark();
    });
  })();

  // ==== JOIN EVENT ====
  (function () {
    const bookBtn = document.getElementById('bookEventBtn');
    const modal = document.getElementById('joinModal');
    const infoBox = document.getElementById('joinEventInfo');
    const confirmBtn = document.getElementById('confirmJoinBtn');
    const cancelBtn = document.getElementById('cancelJoinBtn');
    if (!bookBtn || !modal) return;

    const eventId = bookBtn.dataset.eventId;
    const csrftoken = document.cookie
      .split('; ')
      .find(row => row.startsWith('csrftoken='))
      ?.split('=')[1];

    // ambil data event dari template
    const eventName = "{{ event.name|escapejs }}";
    const eventLoc = "{{ event.location|escapejs }}";
    const eventTime = `{% if not event.end_time %}
      {{ event.start_time|date:"l, d M Y • H:i" }}
      {% elif event.start_time|date:"Y-m-d" == event.end_time|date:"Y-m-d" %}
      {{ event.start_time|date:"l, d M Y • H:i" }} - {{ event.end_time|date:"H:i" }}
      {% else %}
      {{ event.start_time|date:"l, d M Y • H:i" }} - {{ event.end_time|date:"d M Y, H:i" }}
      {% endif %}`.trim();
    const eventFee = `{% if event.fee %}IDR {{ formatted_fee }}{% else %}Free{% endif %}`;

    // klik tombol → buka modal
    bookBtn.addEventListener('click', () => {
      infoBox.innerHTML = `
        <p><span class="font-medium text-gray-700">Event:</span> ${eventName}</p>
        <p><span class="font-medium text-gray-700">Location:</span> ${eventLoc}</p>
        <p><span class="font-medium text-gray-700">Time:</span> ${eventTime}</p>
        <p><span class="font-medium text-gray-700">Fee:</span> ${eventFee}</p>
      `;
      modal.classList.remove('hidden');
    });

    cancelBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });

    confirmBtn.addEventListener('click', async () => {
      try {
        const res = await fetch(`/event/${eventId}/join/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest",
          },
        });
        const data = await res.json();
        if (!data.ok) {
          alert(data.error || "Gagal join event.");
          modal.classList.add('hidden');
          return;
        }
        const counterEl = document.querySelector('[data-attendee-counter]');
        if (counterEl) {
          counterEl.textContent = `${data.joined_count}/${data.capacity}`;
        }
        alert("Kamu berhasil join event 🎉");
      } catch (err) {
        console.error(err);
        alert("Terjadi error. Coba lagi ya.");
      } finally {
        modal.classList.add('hidden');
      }
    });
  })();
</script>



{% endblock content %}
