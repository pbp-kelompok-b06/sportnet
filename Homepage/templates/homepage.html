{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'navbar.html' %}

<!-- Spacer agar header tidak tertutup navbar -->
<div class="h-16 md:h-19"></div>

<header class="text-center bg-[url('{% static 'images/banner.jpg' %}')] bg-no-repeat bg-center bg-cover py-10 px-4">
  {% if request.user.is_authenticated %}
    <h2 class="text-2xl font-bold text-white">Hello, {{ request.user.username }}</h2>
  {% else %}
    <h2 class="text-2xl font-bold text-white">Welcome to SportNet</h2>
  {% endif %}
  <p class="text-gray-500 mb-6 text-white font-extralight">Discover your next adventure here</p>
</header>

<div class="page-container container mx-auto px-4 bg-fixed bg-center bg-no-repeat min-h-screen min-w-full pb-10">
  <!-- Search and filter bar -->
  <div class="max-w-5xl pt-4 mx-auto mb-6">
    <form id="searchForm" method="get" class="flex flex-col md:flex-row items-stretch gap-3">
      <input type="text" name="q" placeholder="Cari event, lokasi, deskripsi..." value="{{ filter_q|default:'' }}" class="flex-1 px-4 py-2 rounded-3xl border border-gray-200" />

      <select name="category" class="px-3 py-2 rounded-3xl border border-gray-200">
        <option value="">Semua Kategori</option>
        {% for code, label in categories %}
          <option value="{{ code }}" {% if filter_category == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <label class="flex items-center gap-2 px-3 py-2 rounded-3xl border border-gray-200 bg-white">
        <input type="checkbox" name="free" value="1" class="h-4 w-4" {% if filter_free == '1' %}checked{% endif %} />
        <span class="text-sm">Gratis</span>
      </label>

      <div class="flex items-center gap-2">
        <button id="searchBtn" type="submit" class="px-4 py-2 bg-gradient-to-b from-[var(--color-main-300)] to-[var(--color-main-400)] hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 text-white rounded-3xl flex items-center gap-2">
          <span id="searchBtnText">Cari</span>
          <svg id="searchSpinner" class="hidden w-4 h-4 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </button>
        <a id="resetBtn" href="{% url 'Homepage:show_main' %}" class="px-4 py-2 bg-white hover:bg-gray-200 border border-gray-200 rounded-3xl">Reset</a>
      </div>
    </form>
  </div>

  <script>
    (function(){
      const form = document.getElementById('searchForm');
      const btn = document.getElementById('searchBtn');
      const spinner = document.getElementById('searchSpinner');
      const btnText = document.getElementById('searchBtnText');

      if (!form) return;

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const params = new URLSearchParams();
        for (const [k,v] of formData.entries()) {
          if (v !== null && v !== undefined && v !== '') params.append(k, v);
        }

        // UI: show loading
        btn.disabled = true;
        spinner.classList.remove('hidden');
        btnText.classList.add('opacity-70');

        try {
          const url = `{% url 'Homepage:search_events_ajax' %}` + '?' + params.toString();
          const resp = await fetch(url, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (!resp.ok) throw new Error('Network response was not ok');
          const html = await resp.text();

          // Replace content: if server returns #event-grid or #no-events container, swap it
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newGrid = doc.getElementById('event-grid');
          const newNo = doc.getElementById('no-events');

          const oldGrid = document.getElementById('event-grid');
          const oldNo = document.getElementById('no-events');

          if (newGrid) {
            if (oldGrid) oldGrid.replaceWith(newGrid);
            else document.querySelector('.page-container').appendChild(newGrid);
            if (oldNo) oldNo.remove();
          } else if (newNo) {
            if (oldGrid) oldGrid.replaceWith(newNo);
            else if (!oldNo) document.querySelector('.page-container').appendChild(newNo);
          }

          // update browser URL so results are shareable
          const newUrl = new URL(window.location);
          // clear existing search params from form fields
          for (const key of ['q','category','free']) newUrl.searchParams.delete(key);
          for (const [k,v] of params.entries()) newUrl.searchParams.set(k, v);
          window.history.pushState({}, '', newUrl);

        } catch (err) {
          console.error('AJAX search failed', err);
        } finally {
          btn.disabled = false;
          spinner.classList.add('hidden');
          btnText.classList.remove('opacity-70');
        }
      });
    })();
  </script>

  {% if events %}
    <div id="event-grid" class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
      {% for event in events %}
        {% include 'card_event.html' with event=event %}
      {% endfor %}
    </div>
  {% else %}
    <div id="no-events" class="rounded-lg border border-gray-200 p-12 text-center max-w-5xl mx-auto my-10">
      <h3 class="text-lg font-medium text-gray-900 mb-2">No event available yet.</h3>
    </div>
  {% endif %}

</div>
{% endblock content %}